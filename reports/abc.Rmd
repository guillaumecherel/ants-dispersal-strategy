---
title: "ABC output report."
output_document: html_document
params:
  datafile: "../openmole/posteriorSample/step2658.csv"
  input_variables: !r c("nest_quality_assessment_error", "new_nest_quality_SD","exploring_phase") 
  prior_bounds: !r list(nest_quality_assessment_error=c(0,50), new_nest_quality_SD=c(0,100), exploring_phase=c(50,5000))
  bins: !r list(nest_quality_assessment_error=20, new_nest_quality_SD=20, exploring_phase=20)
  bandwidth: !r list(nest_quality_assessment_error=5, new_nest_quality_SD=5, exploring_phase=200)
  sampleSize: 2000
---

```{r}
library(ks)
library(igraph)
library(mvtnorm)
library(tidyverse)
library(patchwork)
```

```{r}
datafile <- params$datafile
input_variables <- params$input_variables
prior <- as_tibble(params$prior_bounds)
dimension <- length(input_variables)
bins <- as_tibble(params$bins)
if(is.null(params$bandwidth)) {
  h <- NULL
} else {
  h <- as_tibble(params$bandwidth)
}
sampleSize <- params$sample
```

# Data

```{r}
post <- read_csv(datafile) 

sampleSize <- if (is.null(sampleSize)) nrow(post) else sampleSize

post <- post %>% 
  sample_n(sampleSize) %>% 
  select_at(c(input_variables, "weight")) %>%
  filter(weight > 0) %>%
  mutate(weight = weight / sum(weight))

thetas <- post %>% select_at(input_variables)
weights <- post %>% select(weight)
```

# Kernel density estimate

```{r}
source("kde.R")
```

```{r}
fhat <- kde_bounded_2(thetas, weights, bounds=prior, bins = bins,h = h)
```

Sanity check of the density estimates:

```{r}
fhat$result %>% summarize(sum(density*vcell)) 
```

# Marginales

```{r fig.width=2, fig.height=2}
fhat_marginal <- 
  map(names(thetas), 
      function(v) {
        f <- kde_bounded_2(select(thetas, v), weights, 
                            bounds = select(prior, v), 
                            bins = select(bins, v), 
                            h=select(h, v))
        f$result
      }
    )

plot_marginal <- function(fhat, vname) {
  ggplot(fhat) + geom_line(aes_string(x=vname, y="density")) +
    ylim(0,NA)
}

pmap(list(fhat=fhat_marginal, vname=names(thetas)),
     plot_marginal)
```


# Marginales 2D

```{r fig.width=3, fig.height=2}
variable_pairs <- t(combn(names(thetas), 2))
marginals <- tibble(v1=variable_pairs[,1], v2=variable_pairs[,2])

fhat_marginal_2 <- pmap(marginals, function(v1, v2) {
  f <- kde_bounded_2(thetas[c(v1, v2)], weights, bins=select(bins, v1, v2), 
    bounds=select(prior, v1, v2), h = select(h, v1, v2))
  f$result
  })

plot_marginal_2 <- function(fhat, v1, v2) {
  ggplot(fhat) + geom_raster(aes_string(x=v1, y=v2, fill="density")) +
    scale_fill_viridis_c(limits = c(0,NA))
}

pmap(list(fhat=fhat_marginal_2, v1=marginals$v1, v2=marginals$v2),
      plot_marginal_2)
```


# Is the full joint posterior distribution flat or peaked?

Volume of the set GTau where the density is > tau, as a function of tau.

```{r}
vgtau <- function(fhat, tau) {
  fhat$result %>% 
  filter(density >= tau) %>% 
  summarize(sum(vcell)) %>% 
  deframe()
}

pgtau <- function(fhat, tau) {
  fhat$result %>% 
  filter(density >= tau) %>% 
  summarize(sum(vcell * density)) %>% 
  deframe()
}
```

```{r}
taus <- seq(0, max(fhat$result$density), length.out=50)
ggplot(data.frame(tau=taus, 
                  volume=map_dbl(taus, function(x) vgtau(fhat, x)),
                  cdf=map_dbl(taus, function(x) pgtau(fhat, x)))) +
  geom_line(aes(x=tau, y=volume)) +
  scale_x_reverse() +
  ylab("Volume")
```


# Where are the peaks?

Disjoint components of the subset where the density is > tau, as a function of tau.

```{r}
cgtau <- function(fhat, tau) {
  if(tau <= 0) {
    c <- rep(1, nrow(fhat$result))
  } else {
    nodes <- (1:nrow(fhat$result))[fhat$result$density >= tau]
    g <- induced_subgraph(make_lattice(sapply(fhat$grid_borders, length)), nodes)
    c <- components(g)$membership
  }
  fhat$result %>% 
    filter(density >=tau) %>% 
    group_by(cluster = c) %>%
    filter(density == max(density)) %>%
    ungroup() %>%
    select_at(c(input_variables, "density")) %>%
    mutate(tau=tau)
}

taus <- seq(0, max(fhat$result$density), length.out=100)
cgtaus <- bind_rows(lapply(taus, function(x) cgtau(fhat, x)))
```

Highest position of each peak.

```{r}
cgtaus %>% group_by_at(input_variables) %>% summarize(density=max(density)) %>% ungroup() %>% arrange(desc(density)) 
```

```{r}
ggplot(cgtaus %>% group_by(tau) %>% summarize(clusters = n())) +
  geom_line(aes(x=tau, y=clusters)) +
  scale_x_reverse()
```

# How close to the highest peak is the distribution?

Posterior probability of the parameters being within a sphere centered on the highest density point, as a function of its radius. 

```{r}
# most likely
ml <- fhat$result[which.max(fhat$result$density),]

selected_points <- fhat$result %>% filter(density > 0)

# Distance of each point from the highest density
sp <- selected_points %>% select(input_variables)
repml <- matrix(rep(as.numeric(ml[,input_variables]), each=nrow(sp)), ncol=dimension)
dhd <- sqrt(rowSums((sp - repml) ** 2))

# Cumulative probability as a function of the radius
ppoint <- selected_points$density * selected_points$vcell
sortind <- order(dhd)
prad<- cumsum(ppoint[sortind])

ggplot(data.frame(radius = dhd[sortind], posterior = prad)) +
  geom_line(aes(x=radius, y=posterior))
```

